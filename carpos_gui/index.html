<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CARPOS</title>
    <link rel="icon" href="favicon.ico" type="image/x-icon">
    <script src="https://unpkg.com/eventemitter2@6.4.9/lib/eventemitter2.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r110/three.min.js"></script>
    <script src="libs/STLLoader.js"></script>
    <script src="libs/ColladaLoader.js"></script>
    <script src="libs/OrbitControls.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/roslib@1.3.0/build/roslib.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/ros3d@0.18.0/build/ros3d.min.js"></script>   
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            height: 100vh;
            width: 100vw;
        }
        #container {
            display: flex;
            flex: 1;
        }
        #buttons {
            display: flex;
            flex-direction: column;
            width: 20%;
            padding: 20px;
            box-sizing: border-box;
            background-color: #f0f0f0;
        }
        button {
            padding: 10px;
            font-size: 16px;
            background-color: #007BFF;
            color: white;
            border: none;
            border-radius: 5px;
            margin-bottom: 10px;
            cursor: pointer;
            height: 55px; /* Adjust height as needed */
        }
        button:hover {
            background-color: #0056b3;
        }
        #urdf_viewer {
            display: flex;
            justify-content: center; /* Horizontally center */
            align-items: center; /* Vertically center */
            flex: 1;
            margin: 20px;
            border: 0px solid rgb(0, 0, 0);
        }
        #image_viewer {
            display: flex;
            justify-content: center; /* Horizontally center */
            align-items: center; /* Vertically center */
            flex: 1;
            margin: 20px;
            border: 0px solid rgb(0, 0, 0);
        }
        #rosout {
            height: 20%;
            width: 100%;
            border: 1px solid black;
            overflow-y: auto;
            padding: 10px;
            background-color: #d6d6d6;
            box-sizing: border-box;
        }

        /* Caption style */
        .viewer-caption {
            text-align: center;
            font-size: 25px;
            font-weight: bold;
            margin-top: 0px;
        }

        /* Caption for buttons */
        .button-caption {
            text-align: center;
            font-size: 16px;
            font-weight: bold;
            margin-bottom: 15px;
        }
        .btn-red {
            background-color: red;
            color: white;
        }

        .btn-red:hover {
            background-color: darkred;
        }
        .btn-green {
            background-color: green;
            color: white;
        }
        .btn-green:hover {
            background-color: darkgreen;
        }


    </style>
</head>
<body>
    <h1>CARPOS</h1>

    <div id="container">
        <div id="buttons">
            <div class="button-caption">Control Panel</div> <!-- Added label for the buttons -->
            <button onclick="sendCommand('Command 1')">Initialize</button>
            <button onclick="sendCommand2('redect')" class="btn-red">Redetect</button>
            <button onclick="sendCommand2('ok')" class="btn-green">Confirm</button>
            <button onclick="sendCommand('Command 4')">Start Vis Observation</button>
            <button onclick="sendCommand('Command 5')">Inspection and correction</button>
            <!--<button onclick="sendCommand('Command 6')">Confirm Grasps</button> -->
            <!-- <button onclick="sendCommand('Command 7')">Next Fruit</button> -->
            <button onclick="sendCommand('Command 8')">Execute Harvest</button>
            <!-- <button onclick="sendCommand('Command 9')">Save Current</button> -->
        </div>

        <!--<div>
            <div class="viewer-caption">URDF Viewer</div>
            <div id="urdf_viewer"></div>
        </div> -->

        <div>
            <div class="viewer-caption">Image Viewer</div>
            <div id="image_viewer">
                <img id="image_display" width="640" height="480" />
            </div>
        </div>
    </div>

    <div id="rosout"></div>

    <script>
        // Connect to ROSBridge WebSocket
        const ros = new ROSLIB.Ros({
            //url: 'ws://localhost:9090' // Replace with your Husky's IP and rosbridge port
            url: 'ws://192.168.0.116:9090' 
        });

        ros.on('connection', () => {
            console.log('Connected to ROSBridge');
        });

        ros.on('error', (error) => {
            console.error('Error connecting to ROSBridge:', error);
        });

        ros.on('close', () => {
            console.log('Connection to ROSBridge closed');
        });

        // Button Command Publisher
        function sendCommand(command) {
            const topic = new ROSLIB.Topic({
                ros: ros,
                name: '/command_topic',
                messageType: 'std_msgs/String'
            });

            const message = new ROSLIB.Message({
                data: command
            });

            topic.publish(message);
            console.log(`Sent command: ${command}`);
        }

        // Button Command Publisher
        function sendCommand2(command) {
            const topic = new ROSLIB.Topic({
                ros: ros,
                name: '/ok_redetect',
                messageType: 'std_msgs/String'
            });

            const message = new ROSLIB.Message({
                data: command
            });

            topic.publish(message);
            console.log(`Sent command: ${command}`);
        }
/*
        // URDF Viewer
        const viewer = new ROS3D.Viewer({
            divID: 'urdf_viewer',
            width: 800,
            height: 600,
            antialias: true
        });

        const tfClient = new ROSLIB.TFClient({
            ros: ros,
            fixedFrame: '/base_link', // Replace with your robot's base frame
            angularThres: 0.01,
            transThres: 0.01,
            rate: 10.0
        });


        new ROS3D.UrdfClient({
            ros: ros,
            tfClient: tfClient,
            param: 'robot_description', // Fetch URDF from ROS parameter
            //path: 'http://localhost:9090/', // Replace with the path serving your URDF files
            rootObject: viewer.scene,
            path: 'http://localhost:5500/../ur_description/meshes/ur5e/visual/'  // Corrected path
        });
*/
        // ROS Info Listener
        const rosoutListener = new ROSLIB.Topic({
            ros: ros,
            name: '/rosout',
            messageType: 'rosgraph_msgs/Log'
        });

        rosoutListener.subscribe((message) => {
            const rosoutDiv = document.getElementById('rosout');
            rosoutDiv.innerHTML += `<p>${message.msg}</p>`;
            rosoutDiv.scrollTop = rosoutDiv.scrollHeight; // Auto-scroll to the latest message
        });

          // Subscribe to the image topic
         const imageTopic = new ROSLIB.Topic({
             ros: ros,
             name: '/rs_image', //  image topic
             messageType: 'sensor_msgs/CompressedImage'
         });

         imageTopic.subscribe(function(message) {
             console.log("Received image message:", message);  // Add this
             const imageElement = document.getElementById('image_display');
             imageElement.src = 'data:image/jpeg;base64,' + message.data;
         });

//         imageTopic.subscribe(function(message) {
 //            // Convert the ROS image message to base64
//             const base64Image = rosImageToBase64(message);
//             const imageElement = document.getElementById('image_display');
//             imageElement.src = base64Image; // Update the image source
//         });

// // Convert the ROS image message to a base64 string
// function rosImageToBase64(rosImage) {
//     const bytes = new Uint8Array(rosImage.data);
//     let base64String = '';

//     for (let i = 0; i < bytes.length; i++) {
//         base64String += String.fromCharCode(bytes[i]);
//     }

//     // Return the base64-encoded image (adjusted for JPEG/PNG)
//     return 'data:image/jpeg;base64,' + btoa(base64String);
// }



    </script>
</body>
</html>


